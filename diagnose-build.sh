#!/bin/bash

echo "üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å–±–æ—Ä–∫–∏ qaspilab.com"
echo "=" * 50

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π
echo "üìã –í–µ—Ä—Å–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:"
echo "Node.js: $(node --version)"
echo "npm: $(npm --version)"

# 2. –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –∏ —Ñ–∞–π–ª–æ–≤
echo -e "\nüßπ –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞..."
rm -rf .next
rm -rf node_modules
rm -rf package-lock.json
echo "‚úÖ –ö–µ—à –æ—á–∏—â–µ–Ω"

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "\nüì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ TypeScript –æ—à–∏–±–æ–∫
echo -e "\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ TypeScript..."
npx tsc --noEmit
if [ $? -eq 0 ]; then
    echo "‚úÖ TypeScript –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ TypeScript"
fi

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ ESLint
echo -e "\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ ESLint..."
npx eslint . --ext .ts,.tsx --fix
if [ $? -eq 0 ]; then
    echo "‚úÖ ESLint –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ ESLint"
fi

# 6. –ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
echo -e "\nüèóÔ∏è –ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏ (—Ç–∞–π–º–∞—É—Ç 5 –º–∏–Ω—É—Ç)..."
timeout 300 npm run build

if [ $? -eq 0 ]; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå –°–±–æ—Ä–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –∑–∞ 5 –º–∏–Ω—É—Ç"
    
    # 7. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
    echo -e "\nüîÑ –ü—Ä–æ–±—É–µ–º —Å–±–æ—Ä–∫—É –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π..."
    NODE_OPTIONS="--max-old-space-size=4096" timeout 300 npm run build
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –°–±–æ—Ä–∫–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    else
        echo "‚ùå –°–±–æ—Ä–∫–∞ –≤—Å–µ –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è"
        
        # 8. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏
        echo -e "\nüíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏:"
        free -h
        
        echo -e "\nüìä –†–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞:"
        du -sh .
        du -sh node_modules
        
        echo -e "\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
        echo "1. –£–≤–µ–ª–∏—á–∏—Ç—å RAM —Å–µ—Ä–≤–µ—Ä–∞ (–º–∏–Ω–∏–º—É–º 2GB)"
        echo "2. –î–æ–±–∞–≤–∏—Ç—å swap —Ñ–∞–π–ª"
        echo "3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
        echo "4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
    fi
fi

echo -e "\nüéØ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"